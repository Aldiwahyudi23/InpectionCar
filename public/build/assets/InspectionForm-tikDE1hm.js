import{e as g,o as u,a,f as I,t as L,F as G,h as X,p as ne,d as V,C as Q,D as ie,n as O,k as Z,E as le,b as J,j as de,G as se,c as z,g as ae,x as ue,W as Y,q as ce,w as me,u as T,l as ge,s as he,T as ve,B as oe}from"./app-DHlDNGnu.js";import{l as re}from"./lodash-cQSoYeRT.js";import{_ as K}from"./_plugin-vue_export-helper-DlAUqK2U.js";const pe={class:"mt-1"},fe=["value","required","minlength","maxlength","pattern","placeholder"],we={key:0,class:"mt-2 text-sm text-red-600"},be={__name:"InputText",props:{modelValue:String,required:Boolean,minLength:[String,Number],maxLength:[String,Number],pattern:String,placeholder:String,error:String,pointId:[String,Number]},emits:["update:modelValue","save"],setup(t,{emit:f}){const r=t,p=f,w=y=>{p("update:modelValue",y.target.value),p("save",r.pointId)};return(y,c)=>(u(),g("div",pe,[a("input",{value:t.modelValue,onInput:w,type:"text",required:t.required,minlength:t.minLength,maxlength:t.maxLength,pattern:t.pattern,placeholder:t.placeholder,class:"block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm transition duration-150"},null,40,fe),t.error?(u(),g("p",we,L(t.error),1)):I("",!0)]))}},xe={class:"mt-1"},ye=["value","required","min","max","step","placeholder"],ke={key:0,class:"mt-2 text-sm text-red-600"},_e={__name:"InputNumber",props:{modelValue:[String,Number],required:Boolean,min:[String,Number],max:[String,Number],step:[String,Number],placeholder:String,error:String,pointId:[String,Number]},emits:["update:modelValue","save"],setup(t,{emit:f}){const r=t,p=f,w=y=>{const c=y.target.value;p("update:modelValue",c),p("save",r.pointId)};return(y,c)=>(u(),g("div",xe,[a("input",{value:t.modelValue,onInput:w,type:"number",required:t.required,min:t.min,max:t.max,step:t.step,placeholder:t.placeholder,class:"block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm transition duration-150"},null,40,ye),t.error?(u(),g("p",ke,L(t.error),1)):I("",!0)]))}},Ie={class:"mt-1"},$e=["value","required","min","max"],Ce={key:0,class:"mt-2 text-sm text-red-600"},Se={__name:"InputDate",props:{modelValue:String,required:Boolean,minDate:String,maxDate:String,error:String,pointId:[String,Number]},emits:["update:modelValue","save"],setup(t,{emit:f}){const r=t,p=f,w=y=>{p("update:modelValue",y.target.value),p("save",r.pointId)};return(y,c)=>(u(),g("div",Ie,[a("input",{value:t.modelValue,onChange:w,type:"date",required:t.required,min:t.minDate,max:t.maxDate,class:"block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm transition duration-150"},null,40,$e),t.error?(u(),g("p",Ce,L(t.error),1)):I("",!0)]))}},Ve={class:"mt-1"},Me=["value","required"],Re={key:0,class:"mt-2 text-sm text-red-600"},Le={__name:"InputSelect",props:{modelValue:String,required:Boolean,error:String,pointId:[String,Number]},emits:["update:modelValue","save"],setup(t,{emit:f}){const r=t,p=f,w=y=>{p("update:modelValue",y.target.value),p("save",r.pointId)};return(y,c)=>(u(),g("div",Ve,[a("select",{value:t.modelValue,onChange:w,required:t.required,class:"block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm transition duration-150"},c[0]||(c[0]=[a("option",{value:"",disabled:""},"Select status",-1),a("option",{value:"good"},"Good",-1),a("option",{value:"bad"},"Bad",-1),a("option",{value:"na"},"N/A",-1)]),40,Me),t.error?(u(),g("p",Re,L(t.error),1)):I("",!0)]))}},Ue=K(Le,[["__scopeId","data-v-c34a74db"]]),je={class:"mt-2"},Ne={class:"flex flex-col gap-2 sm:flex-row sm:items-center"},qe=["name","value","checked","onChange","required"],Ee={class:"text-sm text-gray-700"},Pe={key:0,class:"mt-2 text-sm text-red-600"},Be={__name:"InputRadio",props:{modelValue:String,required:Boolean,error:String,pointId:[String,Number],options:{type:Array,default:()=>[{value:"good",label:"Good"},{value:"bad",label:"Bad"},{value:"na",label:"N/A"}]}},emits:["update:modelValue","save"],setup(t,{emit:f}){const r=t,p=f,w=y=>{p("update:modelValue",y),p("save",r.pointId)};return(y,c)=>(u(),g("div",je,[a("div",Ne,[(u(!0),g(G,null,X(t.options,h=>(u(),g("label",{key:h.value,class:"inline-flex items-center space-x-2"},[a("input",{type:"radio",name:"radio-"+t.pointId,value:h.value,checked:t.modelValue===h.value,onChange:$=>w(h.value),required:t.required,class:"text-indigo-600 focus:ring-indigo-500 border-gray-300"},null,40,qe),a("span",Ee,L(h.label),1)]))),128))]),t.error?(u(),g("p",Pe,L(t.error),1)):I("",!0)]))}},Fe={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 p-4"},Te={class:"bg-white w-full max-w-sm rounded-xl shadow-xl overflow-hidden"},We={class:"p-4"},Ae={class:"flex justify-center gap-6"},De={__name:"ImageSourceOptionsModal",props:{show:{type:Boolean,default:!1}},emits:["close","openWebcam","triggerGallery"],setup(t){return(f,r)=>t.show?(u(),g("div",Fe,[a("div",Te,[a("div",We,[r[5]||(r[5]=a("h3",{class:"text-lg font-medium text-center text-gray-800 mb-4"},"Select Image Source",-1)),a("div",Ae,[a("button",{onClick:r[0]||(r[0]=p=>f.$emit("openWebcam")),class:"flex flex-col items-center justify-center w-24 h-24 rounded-xl bg-blue-50 hover:bg-blue-100 transition-colors"},r[3]||(r[3]=[ne('<div class="bg-blue-100 p-3 rounded-full mb-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div><span class="text-sm font-medium text-gray-700">Camera</span>',2)])),a("button",{onClick:r[1]||(r[1]=p=>f.$emit("triggerGallery")),class:"flex flex-col items-center justify-center w-24 h-24 rounded-xl bg-purple-50 hover:bg-purple-100 transition-colors"},r[4]||(r[4]=[a("div",{class:"bg-purple-100 p-3 rounded-full mb-2"},[a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6 text-purple-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})])],-1),a("span",{class:"text-sm font-medium text-gray-700"},"Gallery",-1)]))])]),a("button",{onClick:r[2]||(r[2]=p=>f.$emit("close")),class:"w-full py-3 text-center text-gray-500 font-medium border-t border-gray-100 hover:bg-gray-50 transition-colors"},"Cancel")])])):I("",!0)}},ze={key:0,class:"fixed inset-0 z-40 p-0 webcam-modal-container"},He={class:"webcam-content-box"},Oe={class:"webcam-header"},Ge={class:"flex gap-4"},Xe=["disabled"],Ke={key:0,xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},Ye={key:1,xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},Je={key:2,xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},Qe=["disabled"],Ze={key:0,class:"screen-flash-overlay"},et={__name:"WebcamModal",props:{show:Boolean,aspectRatio:Number,settings:Object},emits:["close","photoCaptured"],setup(t,{emit:f}){const r=t,p=f,w=V(null),y=V(null);let c=null,h=null;const $=V("environment"),v=V(!1),k=V(!1),s=V(!1),M=V(!1),N=async()=>{c&&c.getTracks().forEach(o=>o.stop()),s.value=!1;try{const o={facingMode:$.value,width:{ideal:1280},height:{ideal:960},aspectRatio:{exact:r.aspectRatio}};$.value==="environment"&&(o.advanced=[{focusMode:"continuous"}]),c=await navigator.mediaDevices.getUserMedia({video:o}),h=c.getVideoTracks()[0],w.value.srcObject=c,w.value.onloadedmetadata=async()=>{w.value.style.width="100%",w.value.style.height="auto",w.value.style.objectFit="cover",await P()}}catch(o){console.error("Error accessing camera: ",o),alert("Failed to access camera. Please ensure camera permissions are granted and try again."),p("close")}},q=()=>{c&&c.getTracks().forEach(o=>o.stop()),p("close")},P=async()=>{if(!h)return;const m=(await navigator.mediaDevices.enumerateDevices()).filter(_=>_.kind==="videoinput");v.value=m.length>1;const S=h.getCapabilities();k.value=S.torch||S.fillLightMode&&S.fillLightMode.includes("torch")},U=async()=>{if(!(!h||!r.settings.enable_flash)){if($.value==="user"){s.value=!s.value;return}try{if(h.getCapabilities().torch)await h.applyConstraints({advanced:[{torch:!s.value}]}),s.value=!s.value;else{console.warn("Torch API not directly supported, checking fillLightMode.");const o=h.getCapabilities();o.fillLightMode&&o.fillLightMode.includes("torch")?(await h.applyConstraints({fillLightMode:s.value?"none":"torch"}),s.value=!s.value):(alert("Flash/Torch is not supported on this camera."),k.value=!1)}}catch(o){console.error("Error toggling flash: ",o),alert("Could not toggle flash. Feature might not be supported."),k.value=!1}}},R=async()=>{!v.value||!r.settings.enable_camera_switch||($.value=$.value==="environment"?"user":"environment",await N())},i=async()=>{if(!h)return;const o=h.getCapabilities();if(o.focusMode&&o.focusMode.includes("continuous"))try{await h.applyConstraints({advanced:[{focusMode:"continuous"}]})}catch(m){console.warn("Failed to apply continuous focus constraint:",m)}else console.log("Autofocus not explicitly controllable or not supported.")},d=async()=>{if(!w.value||!y.value)return;$.value==="user"&&s.value&&(M.value=!0,await new Promise(e=>setTimeout(e,100)),M.value=!1);const o=w.value,m=y.value,S=m.getContext("2d"),_=o.videoWidth,C=o.videoHeight;let j=_,B=C,A=0,D=0;_/C>r.aspectRatio?(j=C*r.aspectRatio,A=(_-j)/2):_/C<r.aspectRatio&&(B=_/r.aspectRatio,D=(C-B)/2),m.width=j,m.height=B,S.drawImage(o,A,D,j,B,0,0,m.width,m.height),m.toBlob(e=>{if(e){const b=new File([e],`captured_image_${Date.now()}.png`,{type:"image/png"});p("photoCaptured",b)}else console.error("Failed to convert canvas to blob.")},"image/png")};return Q(()=>r.show,o=>{o?N():q()}),ie(()=>{c&&c.getTracks().forEach(o=>o.stop())}),(o,m)=>t.show?(u(),g("div",ze,[a("div",He,[a("div",Oe,[a("button",{onClick:q,class:"p-2 rounded-full text-white hover:bg-gray-700 transition-colors"},m[0]||(m[0]=[a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])),a("div",Ge,[t.settings.enable_flash?(u(),g("button",{key:0,onClick:U,disabled:!k.value,class:O(["p-2 rounded-full text-white",{"bg-gray-700":s.value,"hover:bg-gray-700":k.value,"opacity-50 cursor-not-allowed":!k.value}])},[k.value?s.value?(u(),g("svg",Ye,m[2]||(m[2]=[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 10V3L4 14h7v7l9-11h-7z"},null,-1)]))):(u(),g("svg",Je,m[3]||(m[3]=[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 10V3L4 14h7v7l9-11h-7z"},null,-1),a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6"},null,-1)]))):(u(),g("svg",Ke,m[1]||(m[1]=[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.102 1.101m-.757 4.898l-4 4L9.828 9.828m4.899-.757l4-4L14.172 14.172"},null,-1)])))],10,Xe)):I("",!0),t.settings.enable_camera_switch?(u(),g("button",{key:1,onClick:R,disabled:!v.value,class:O(["p-2 rounded-full text-white hover:bg-gray-700",{"opacity-50 cursor-not-allowed":!v.value}])},m[4]||(m[4]=[a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 8h16M4 16h16M6 4h.01M6 20h.01M10 4h.01M10 20h.01M14 4h.01M14 20h.01M18 4h.01M18 20h.01"})],-1)]),10,Qe)):I("",!0)])]),a("div",{class:"webcam-video-container",onClick:i},[a("video",{ref_key:"webcamVideo",ref:w,autoplay:"",playsinline:"",class:"webcam-video"},null,512),a("canvas",{ref_key:"webcamCanvas",ref:y,class:"hidden"},null,512),M.value?(u(),g("div",Ze)):I("",!0)]),a("div",{class:"webcam-footer"},[a("button",{onClick:d,class:"capture-button"})])])])):I("",!0)}},tt=K(et,[["__scopeId","data-v-486b3fb6"]]),at={key:0,class:"fixed inset-0 bg-black bg-opacity-90 z-50 flex flex-col items-center justify-center"},st={class:"w-full h-full flex flex-col"},ot={class:"flex justify-between items-center p-4 bg-black bg-opacity-50 text-white"},rt={class:"text-lg font-medium"},nt={class:"flex-1 flex items-center justify-center overflow-hidden relative"},lt=["src"],it={class:"flex justify-between p-4 bg-black bg-opacity-50"},dt={__name:"ImagePreviewModal",props:{show:Boolean,images:{type:Array,default:()=>[]},initialIndex:{type:Number,default:0},allowMultiple:Boolean,maxFiles:Number},emits:["close","saveImages","removePreviewImage"],setup(t,{emit:f}){const r=t,p=f,w=V(r.initialIndex),y=V(0),c=V(0),h=Z(()=>r.images.length>0?r.images[w.value]:null);Q(()=>r.initialIndex,R=>{w.value=R},{immediate:!0});const $=()=>{h.value&&(h.value.rotation=(h.value.rotation+90)%360)},v=()=>{w.value<r.images.length-1&&w.value++},k=()=>{w.value>0&&w.value--},s=R=>{y.value=R.touches[0].clientX},M=R=>{c.value=R.touches[0].clientX},N=()=>{y.value-c.value>50?v():c.value-y.value>50&&k()},q=()=>{r.images.length!==0&&(p("removePreviewImage",w.value),w.value>=r.images.length&&(w.value=Math.max(0,r.images.length-1)),r.images.length===0&&U())},P=()=>{p("saveImages",r.images)},U=()=>{p("close")};return Q(()=>r.show,R=>{R?document.body.classList.add("modal-open"):document.body.classList.remove("modal-open")},{immediate:!0}),(R,i)=>t.show?(u(),g("div",at,[a("div",st,[a("div",ot,[a("button",{onClick:U,class:"p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition-colors"},i[0]||(i[0]=[a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])),a("div",rt,"Preview ("+L(w.value+1)+"/"+L(t.images.length)+")",1),a("button",{onClick:$,class:"p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition-colors"},i[1]||(i[1]=[a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})],-1)]))]),a("div",nt,[a("div",{class:"w-full h-full flex items-center justify-center",onTouchstart:s,onTouchmove:M,onTouchend:N},[h.value?(u(),g("img",{key:0,src:h.value.preview||`/storage/${h.value.image_path}`,class:"max-w-full max-h-full object-contain",style:le({transform:`rotate(${h.value.rotation}deg)`})},null,12,lt)):I("",!0)],32),t.images.length>1?(u(),g("button",{key:0,onClick:k,class:"absolute left-4 p-2 bg-black bg-opacity-50 text-white rounded-full hover:bg-opacity-70 transition-colors"},i[2]||(i[2]=[a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)]))):I("",!0),t.images.length>1?(u(),g("button",{key:1,onClick:v,class:"absolute right-4 p-2 bg-black bg-opacity-50 text-white rounded-full hover:bg-opacity-70 transition-colors"},i[3]||(i[3]=[a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"})],-1)]))):I("",!0)]),a("div",it,[a("button",{onClick:q,class:"px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"}," Delete "),a("button",{onClick:P,class:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"}," Save "+L(t.images.length)+" Image(s) ",1)])])])):I("",!0)}},ut=K(dt,[["__scopeId","data-v-20d483c7"]]),ct=["multiple"],mt={key:1,class:"block w-full border-2 border-dashed rounded-lg transition-colors duration-200 border-indigo-300 bg-indigo-50 h-auto p-2","aria-label":"Image gallery"},gt={class:"grid grid-cols-3 gap-2"},ht=["onClick"],vt=["src"],pt=["onClick"],ft={key:0,class:"mt-2 text-center"},wt={key:2,class:"mt-1 text-xs text-red-600"},bt={__name:"InputImage",props:{modelValue:{type:Array,default:()=>[]},error:String,inspectionId:{type:[String,Number],required:!1},pointId:{type:[String,Number],required:!0},settings:{type:Object,default:()=>({max_files:1,allowed_types:["jpg","png"],camera_aspect_ratio:"4:3",enable_flash:!0,enable_camera_switch:!0})}},emits:["update:modelValue","save","removeImage","uploaded"],setup(t,{emit:f}){const r=t,p=f,w=V(null),y=V(null),c=V(!1),h=V(!1),$=V(!1),v=V([]),k=V(0),s=V(!1),M=Z(()=>Number(r.settings.max_files)>1),N=Z(()=>{const e=r.settings.camera_aspect_ratio.split(":");if(e.length===2){const b=parseFloat(e[0]),n=parseFloat(e[1]);if(!isNaN(b)&&!isNaN(n)&&n!==0)return b/n}return 4/3}),q=e=>e.preview||(e.image_path?`/${e.image_path}`:""),P=e=>!e.width||!e.height||e.width===0||e.height===0?{paddingBottom:"100%",position:"relative"}:{paddingBottom:`${e.height/e.width*100}%`,position:"relative"},U=()=>{c.value=!0},R=()=>{c.value=!1,w.value.click()},i=e=>new Promise(b=>{const n=new FileReader;n.onload=l=>{const x=new Image;x.onload=()=>{b({file:e,preview:URL.createObjectURL(e),rotation:0,width:x.naturalWidth,height:x.naturalHeight,isNew:!0})},x.onerror=()=>{console.error("Failed to load image for dimensions:",e.name),b({file:e,preview:URL.createObjectURL(e),rotation:0,width:0,height:0,isNew:!0})},x.src=l.target.result},n.readAsDataURL(e)}),d=e=>{const b=Array.from(e.target.files);b.length&&(M.value||(v.value.forEach(n=>n.preview&&n.preview.startsWith("blob:")&&URL.revokeObjectURL(n.preview)),v.value=[]),Promise.all(b.map(i)).then(n=>{const l=r.modelValue.length+v.value.length,x=r.settings.max_files-l,E=M.value?n.slice(0,x):n.slice(0,1);v.value.push(...E),k.value=v.value.length-1,$.value=!0,e.target.value=""}).catch(n=>{console.error("Error processing selected images:",n),alert("Failed to process selected images. Please try again.")}))},o=()=>{c.value=!1,h.value=!0},m=()=>{h.value=!1},S=e=>{const b=r.modelValue.length+v.value.length;if(!M.value||b<r.settings.max_files){const n=new Image;n.onload=()=>{const l={file:e,preview:URL.createObjectURL(e),rotation:0,width:n.naturalWidth,height:n.naturalHeight,isNew:!0};M.value?v.value.push(l):(v.value.forEach(x=>x.preview&&x.preview.startsWith("blob:")&&URL.revokeObjectURL(x.preview)),v.value=[l]),k.value=v.value.length-1,h.value=!1,$.value=!0},n.onerror=()=>{console.error("Failed to load captured image for dimensions.");const l={file:e,preview:URL.createObjectURL(e),rotation:0,width:0,height:0,isNew:!0};M.value?v.value.push(l):(v.value.forEach(x=>x.preview&&x.preview.startsWith("blob:")&&URL.revokeObjectURL(x.preview)),v.value=[l]),k.value=v.value.length-1,h.value=!1,$.value=!0},n.src=URL.createObjectURL(e)}else alert(`Maximum ${r.settings.max_files} files allowed.`),h.value=!1},_=async(e=0)=>{const b=await Promise.all(r.modelValue.map(async l=>{if(l.width&&l.height&&l.image_path)return{...l,rotation:l.rotation||0,isNew:!1};{const x=new Image;return new Promise(E=>{x.onload=()=>E({...l,rotation:l.rotation||0,preview:l.image_path?`/${l.image_path}`:null,width:x.naturalWidth,height:x.naturalHeight,isNew:!1}),x.onerror=()=>E({...l,rotation:l.rotation||0,preview:l.image_path?`/${l.image_path}`:null,width:0,height:0,isNew:!1}),x.src=l.image_path?`/${l.image_path}`:""})}})),n=v.value.filter(l=>l.isNew||l.rotation!==0);v.value=[...b,...n],k.value=e,$.value=!0},C=()=>{$.value=!1,v.value.forEach(e=>{e.preview&&e.preview.startsWith("blob:")&&URL.revokeObjectURL(e.preview)}),v.value=[]},j=e=>new Promise(b=>{if(e.rotation===0||!y.value){b({file:e.file,width:e.width,height:e.height});return}const n=new Image;n.onload=()=>{const l=y.value,x=l.getContext("2d"),E=n.width,F=n.height;let W,H;e.rotation===90||e.rotation===270?(W=F,H=E):(W=E,H=F),l.width=W,l.height=H,x.clearRect(0,0,l.width,l.height),x.translate(l.width/2,l.height/2),x.rotate(e.rotation*Math.PI/180),x.drawImage(n,-E/2,-F/2,E,F),x.setTransform(1,0,0,1,0,0),l.toBlob(ee=>{const te=new File([ee],e.file.name,{type:e.file.type});b({file:te,width:W,height:H})},e.file.type)},n.onerror=()=>{console.error("Failed to load image for rotation processing:",e.preview),b({file:e.file,width:e.width,height:e.height})},n.src=e.preview}),B=async e=>{s.value=!0;const b=[];if(!r.pointId){alert("Error: Point ID is missing. Cannot upload image. (Check parent component)"),s.value=!1;return}console.log("Uploading for Inspection ID:",r.inspectionId,"Point ID:",r.pointId);try{for(const n of e)if(n.isNew||n.rotation!==0){const{file:l,width:x,height:E}=await j(n),F=new FormData;F.append("inspection_id",r.inspectionId),F.append("point_id",r.pointId),F.append("image",l);const W=await se.post(route("inspections.upload-image"),F,{headers:{"Content-Type":"multipart/form-data"}}),H=W.data.image,ee=W.data.path,te=W.data.public_url;b.push({id:H.id,image_path:ee,width:x,height:E,rotation:0,preview:te}),n.preview&&n.preview.startsWith("blob:")&&URL.revokeObjectURL(n.preview)}else b.push({...n,preview:n.preview||`/${n.image_path}`});p("update:modelValue",b.slice(0,r.settings.max_files)),p("save",r.pointId),p("uploaded",{pointId:r.pointId,images:b}),C()}catch(n){if(console.error("Error during image processing/upload:",n),n.response&&n.response.data&&n.response.data.message)alert(`Failed to save images: ${n.response.data.message}`);else if(n.response&&n.response.data&&n.response.data.errors){const l=Object.values(n.response.data.errors).flat().join(`
`);alert(`Failed to save images:
${l}`)}else alert(`Failed to save images: ${n.message}`)}finally{s.value=!1}},A=e=>{v.value.splice(e,1)},D=async e=>{const b=[...r.modelValue],n=b.splice(e,1)[0];if(n.id||n.image_path)try{await se.delete(route("inspections.delete-image"),{data:{image_path:n.image_path,image_id:n.id}}),alert("Image deleted from server successfully!")}catch(l){if(console.error("Error deleting image from server:",l),l.response&&l.response.data&&l.response.data.message)alert(`Failed to delete image from server: ${l.response.data.message}`);else if(l.response&&l.response.data&&l.response.data.errors){const x=Object.values(l.response.data.errors).flat().join(`
`);alert(`Failed to delete image:
${x}`)}else alert(`Failed to delete image from server: ${l.message}`)}n.preview&&n.preview.startsWith("blob:")&&URL.revokeObjectURL(n.preview),p("update:modelValue",b),p("removeImage",{index:e,pointId:r.pointId,image:n}),b.length===0&&C()};return(e,b)=>(u(),g("div",null,[a("input",{ref_key:"galleryInput",ref:w,type:"file",accept:"image/*",class:"hidden",onChange:d,multiple:M.value},null,40,ct),a("canvas",{ref_key:"processingCanvas",ref:y,class:"hidden"},null,512),t.modelValue.length===0?(u(),g("label",{key:0,onClick:U,class:O(["block w-full border-2 border-dashed rounded-lg cursor-pointer transition-colors duration-200 h-28",{"border-gray-300 hover:border-indigo-400 bg-gray-50":!0}])},b[1]||(b[1]=[ne('<div class="h-full flex flex-col items-center justify-center p-4 text-center"><svg class="w-8 h-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><p class="text-sm text-gray-600 font-medium">Upload Image</p><p class="text-xs text-gray-500">Click to open options</p></div>',1)]))):(u(),g("div",mt,[a("div",gt,[(u(!0),g(G,null,X(t.modelValue,(n,l)=>(u(),g("div",{key:n.id||l,class:"relative w-full overflow-hidden rounded-md border border-gray-200 cursor-pointer",style:le(P(n)),onClick:x=>_(l)},[a("img",{src:q(n),class:"absolute top-0 left-0 w-full h-full object-contain"},null,8,vt),a("button",{onClick:de(x=>D(l),["stop"]),type:"button",class:"absolute top-1 right-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs shadow-sm hover:bg-red-600 transition-colors z-10","aria-label":"Remove image"}," × ",8,pt)],12,ht))),128))]),M.value&&t.modelValue.length<t.settings.max_files?(u(),g("div",ft,[a("span",{onClick:U,class:"inline-block px-3 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 hover:bg-indigo-200 transition-colors cursor-pointer"}," + Add More Images ")])):I("",!0)])),t.error?(u(),g("p",wt,L(t.error),1)):I("",!0),J(De,{show:c.value,onClose:b[0]||(b[0]=n=>c.value=!1),onOpenWebcam:o,onTriggerGallery:R},null,8,["show"]),J(tt,{show:h.value,"aspect-ratio":N.value,settings:t.settings,onClose:m,onPhotoCaptured:S},null,8,["show","aspect-ratio","settings"]),J(ut,{show:$.value,images:v.value,"initial-index":k.value,"allow-multiple":M.value,"max-files":t.settings.max_files,"is-uploading":s.value,onClose:C,onSaveImages:B,onRemovePreviewImage:A},null,8,["show","images","initial-index","allow-multiple","max-files","is-uploading"])]))}},xt={class:"bg-white shadow-lg rounded-xl overflow-hidden border border-gray-100"},yt={class:"bg-indigo-50 px-6 py-2 border-b border-indigo-100"},kt={class:"text-xl font-semibold text-indigo-700"},_t={class:"p-4 space-y-4"},It={class:"flex items-start justify-between"},$t={class:"block text-sm font-medium text-gray-700"},Ct={key:0,class:"text-red-500"},St={key:0,class:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800"},Vt={__name:"CategorySection",props:{category:Object,form:Object,inspectionId:[String,Number]},emits:["saveResult","updateResult","removeImage"],setup(t,{emit:f}){const r=t,p=f,w=[{value:"good",label:"Good"},{value:"bad",label:"Bad"},{value:"na",label:"N/A"}],y=v=>{var s;const k=r.form.results[v.id];if(!k)return!1;switch(v.input_type){case"text":case"number":case"date":return!!k.note;case"select":case"radio":return!!k.status;case"image":return((s=k.images)==null?void 0:s.length)>0;default:return!1}},c=(v,k)=>{p("updateResult",{pointId:v,value:k})},h=v=>{p("saveResult",v)},$=(v,k)=>{p("removeImage",{pointId:v,imageIndex:k})};return(v,k)=>(u(),g("div",xt,[a("div",yt,[a("h2",kt,L(t.category.name),1)]),a("div",_t,[(u(!0),g(G,null,X(t.category.points,s=>{var M,N,q,P,U,R,i,d,o,m,S,_,C,j,B,A,D;return u(),g("div",{key:s.id,class:"space-y-2 pb-4 border-b border-gray-100 last:border-0 last:pb-0"},[a("div",It,[a("label",$t,[ae(L(s.name)+" ",1),(M=s.settings)!=null&&M.is_required?(u(),g("span",Ct,"*")):I("",!0)]),y(s)?(u(),g("span",St," ✓ ")):I("",!0)]),s.input_type==="text"?(u(),z(be,{key:0,modelValue:t.form.results[s.id].note,"onUpdate:modelValue":[e=>t.form.results[s.id].note=e,e=>c(s.id,e)],required:(N=s.settings)==null?void 0:N.is_required,"min-length":(q=s.settings)==null?void 0:q.min_length,"max-length":(P=s.settings)==null?void 0:P.max_length,pattern:(U=s.settings)==null?void 0:U.pattern,placeholder:((R=s.settings)==null?void 0:R.placeholder)||"Enter text",error:t.form.errors[`results.${s.id}.note`],onSave:e=>h(s.id)},null,8,["modelValue","onUpdate:modelValue","required","min-length","max-length","pattern","placeholder","error","onSave"])):I("",!0),s.input_type==="number"?(u(),z(_e,{key:1,modelValue:t.form.results[s.id].note,"onUpdate:modelValue":[e=>t.form.results[s.id].note=e,e=>c(s.id,e)],required:(i=s.settings)==null?void 0:i.is_required,min:(d=s.settings)==null?void 0:d.min,max:(o=s.settings)==null?void 0:o.max,step:((m=s.settings)==null?void 0:m.step)||1,placeholder:((S=s.settings)==null?void 0:S.placeholder)||"Enter number",error:t.form.errors[`results.${s.id}.note`],onSave:e=>h(s.id)},null,8,["modelValue","onUpdate:modelValue","required","min","max","step","placeholder","error","onSave"])):I("",!0),s.input_type==="date"?(u(),z(Se,{key:2,modelValue:t.form.results[s.id].note,"onUpdate:modelValue":[e=>t.form.results[s.id].note=e,e=>c(s.id,e)],required:(_=s.settings)==null?void 0:_.is_required,"min-date":(C=s.settings)==null?void 0:C.min_date,"max-date":(j=s.settings)==null?void 0:j.max_date,error:t.form.errors[`results.${s.id}.note`],onSave:e=>h(s.id)},null,8,["modelValue","onUpdate:modelValue","required","min-date","max-date","error","onSave"])):I("",!0),s.input_type==="select"?(u(),z(Ue,{key:3,modelValue:t.form.results[s.id].status,"onUpdate:modelValue":[e=>t.form.results[s.id].status=e,e=>c(s.id,e)],required:(B=s.settings)==null?void 0:B.is_required,error:t.form.errors[`results.${s.id}.status`],onSave:e=>h(s.id)},null,8,["modelValue","onUpdate:modelValue","required","error","onSave"])):I("",!0),s.input_type==="radio"?(u(),z(Be,{key:4,modelValue:t.form.results[s.id].status,"onUpdate:modelValue":[e=>t.form.results[s.id].status=e,e=>c(s.id,e)],required:(A=s.settings)==null?void 0:A.is_required,options:((D=s.settings)==null?void 0:D.radios)||w,error:t.form.errors[`results.${s.id}.status`],onSave:e=>h(s.id)},null,8,["modelValue","onUpdate:modelValue","required","options","error","onSave"])):I("",!0),s.input_type==="image"?(u(),z(bt,{key:5,modelValue:t.form.results[s.id].images,"onUpdate:modelValue":[e=>t.form.results[s.id].images=e,e=>c(s.id,e)],error:t.form.errors[`results.${s.id}.images`],"inspection-id":t.inspectionId,"point-id":s.id,onSave:e=>h(s.id),onRemoveImage:e=>$(s.id,e)},null,8,["modelValue","onUpdate:modelValue","error","inspection-id","point-id","onSave","onRemoveImage"])):I("",!0)])}),128))])]))}},Mt=K(Vt,[["__scopeId","data-v-b0fe3fb7"]]),Rt={class:"container mx-auto px-4 py-2"},Lt={class:"sticky top-0 z-10 bg-white shadow-sm mb-2"},Ut={class:"flex overflow-x-auto scrollbar-hide py-3 px-4 space-x-2"},jt=["onClick","data-category-id"],Nt={key:0,class:"ml-2 inline-flex items-center justify-center w-5 h-5 text-xs rounded-full bg-green-500 text-white"},qt={class:"relative overflow-hidden"},Et={key:"summary-section",class:"bg-white rounded-xl shadow-md p-6"},Pt={class:"mb-4"},Bt={class:"mt-6"},Ft={class:"list-disc pl-5"},Tt={key:0},Wt={key:1},At={class:"flex justify-end gap-4 mt-8"},Dt=["disabled"],zt={key:0,class:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},Ht={__name:"InspectionForm",props:{inspection:Object,categories:Array,existingResults:Array,existingImages:Object},setup(t){var R;const f=t,r=V(((R=f.categories[0])==null?void 0:R.id)||"summary"),p=V(0);V(null);const w=Z(()=>r.value!=="summary"?f.categories.find(i=>i.id===r.value):null),c=ue((()=>{const i={};return f.categories.forEach(d=>{(d.points||[]).forEach(o=>{var S,_;const m=Array.isArray(f.existingResults)?f.existingResults.find(C=>C.point_id===o.id):null;i[o.id]={status:(m==null?void 0:m.status)||"",note:(m==null?void 0:m.note)||"",images:((_=(S=f.existingImages)==null?void 0:S[o.id])==null?void 0:_.map(C=>({image_path:C.image_path,preview:null})))||[]}})}),{inspection_id:f.inspection.id,results:i,overall_note:f.inspection.overall_note||""}})()),h=re.debounce(()=>{Y.post(route("inspections.save-overall-note"),{inspection_id:f.inspection.id,overall_note:c.overall_note},{preserveScroll:!0,preserveState:!0,only:["inspection"],onSuccess:()=>{},onError:i=>{console.error("Error menyimpan catatan keseluruhan:",i)}})},800),$=i=>i.points.every(d=>{var m;const o=c.results[d.id];if(!o)return!1;switch(d.input_type){case"text":case"number":case"date":return!!o.note;case"select":case"radio":return!!o.status;case"image":return((m=o.images)==null?void 0:m.length)>0;default:return!!o.status||!!o.note}}),v=i=>{if(i==="summary")p.value=f.categories.length;else{const d=f.categories.findIndex(o=>o.id===i);d>=0&&(p.value=d)}r.value=i},k=i=>{let d=p.value+i;const o=f.categories.length;d>=0&&d<=o&&(p.value=d,d===o?r.value="summary":r.value=f.categories[d].id)},s=()=>{let i=0,d=0;const o=C=>{i=C.changedTouches[0].screenX},m=C=>{d=C.changedTouches[0].screenX,S()},S=()=>{d<i-50?k(1):d>i+50&&k(-1)},_=document.querySelector(".relative.overflow-hidden");return _&&(_.addEventListener("touchstart",o,!1),_.addEventListener("touchend",m,!1)),()=>{_&&(_.removeEventListener("touchstart",o),_.removeEventListener("touchend",m))}},M=re.debounce(async i=>{try{await Y.post(route("inspections.save-result"),{inspection_id:f.inspection.id,point_id:i,status:c.results[i].status,note:c.results[i].note},{preserveScroll:!0,preserveState:!0,only:["existingResults"],onSuccess:()=>{}})}catch(d){console.error("Error menyimpan hasil:",d)}},500),N=({pointId:i,type:d,value:o})=>{c.results[i].hasOwnProperty(d)&&(c.results[i][d]=o),M(i)},q=async(i,d)=>{const o=i.target.files[0];if(!o)return;const m=URL.createObjectURL(o);try{const S=new FormData;S.append("inspection_id",f.inspection.id),S.append("point_id",d),S.append("image",o),await Y.post(route("inspections.upload-image"),S,{preserveScroll:!0,onSuccess:_=>{var j;const C=((j=_.props.flash)==null?void 0:j.imagePath)||_.props.imagePath;C?c.results[d].images.push({image_path:C,preview:m}):console.error("Path gambar tidak dikembalikan dari unggahan, tidak dapat memperbarui UI.")},onError:_=>{console.error("Error mengunggah gambar:",_),alert("Gagal mengunggah gambar. Silakan coba lagi.")}})}catch(S){console.error("Error mengunggah gambar:",S),alert("Terjadi kesalahan tak terduga saat mengunggah gambar.")}finally{i.target.value=""}},P=async(i,d)=>{const o=c.results[i].images[d];if(o)try{await Y.delete(route("inspections.delete-image"),{data:{image_path:o.image_path,point_id:i,inspection_id:f.inspection.id},preserveScroll:!0,onSuccess:()=>{c.results[i].images.splice(d,1),o.preview&&URL.revokeObjectURL(o.preview)},onError:m=>{console.error("Error menghapus gambar:",m),alert("Gagal menghapus gambar. Silakan coba lagi.")}})}catch(m){console.error("Error menghapus gambar:",m),alert("Terjadi kesalahan tak terduga saat menghapus gambar.")}},U=()=>{c.post(route("inspections.final-submit"),{preserveScroll:!0,onSuccess:()=>{oe().props.flash.success="Inspeksi berhasil dikirim!"},onError:i=>{console.error("Kesalahan pengiriman:",i),oe().props.flash.error="Ada kesalahan dalam pengiriman Anda. Harap periksa semua bidang."}})};return ce(()=>{s()}),Q(r,i=>{const d=document.querySelector(`.flex-shrink-0[data-category-id="${i}"]`);d&&d.scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"})}),(i,d)=>(u(),g("div",Rt,[a("div",Lt,[a("div",Ut,[(u(!0),g(G,null,X(t.categories,o=>(u(),g("button",{key:o.id,onClick:m=>v(o.id),class:O(["flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors duration-200",{"bg-indigo-600 text-white":r.value===o.id,"bg-gray-100 text-gray-700 hover:bg-gray-200":r.value!==o.id}]),"data-category-id":o.id},[ae(L(o.name)+" ",1),$(o)?(u(),g("span",Nt," ✓ ")):I("",!0)],10,jt))),128)),a("button",{onClick:d[0]||(d[0]=o=>v("summary")),class:O(["flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors duration-200",{"bg-indigo-600 text-white":r.value==="summary","bg-gray-100 text-gray-700 hover:bg-gray-200":r.value!=="summary"}]),"data-category-id":"summary"}," Kesimpulan ",2)])]),a("div",qt,[J(ve,{name:"category-slide",mode:"out-in"},{default:me(()=>[w.value&&r.value!=="summary"?(u(),z(Mt,{key:w.value.id,category:w.value,form:T(c),onSaveResult:T(M),onUpdateResult:N,onRemoveImage:P,onHandleImageUpload:q},null,8,["category","form","onSaveResult"])):r.value==="summary"?(u(),g("div",Et,[d[6]||(d[6]=a("h3",{class:"text-2xl font-semibold text-gray-800 mb-4"},"Kesimpulan Inspeksi",-1)),a("div",Pt,[d[3]||(d[3]=a("label",{for:"overall_note",class:"block text-sm font-medium text-gray-700 mb-1"},"Catatan Keseluruhan Inspeksi:",-1)),ge(a("textarea",{id:"overall_note","onUpdate:modelValue":d[1]||(d[1]=o=>T(c).overall_note=o),onInput:d[2]||(d[2]=(...o)=>T(h)&&T(h)(...o)),rows:"5",class:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",placeholder:"Tambahkan catatan penting atau ringkasan inspeksi di sini..."},null,544),[[he,T(c).overall_note]])]),a("div",Bt,[d[4]||(d[4]=a("h4",{class:"text-lg font-semibold text-gray-700 mb-3"},"Status Kategori:",-1)),a("ul",Ft,[(u(!0),g(G,null,X(t.categories,o=>(u(),g("li",{key:o.id,class:O({"text-green-600":$(o),"text-red-600":!$(o)})},[ae(L(o.name)+" ",1),$(o)?(u(),g("span",Tt,"(Selesai ✓)")):(u(),g("span",Wt,"(Belum Selesai ✗)"))],2))),128))])]),a("div",At,[a("button",{type:"button",onClick:U,disabled:T(c).processing,class:"inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"},[T(c).processing?(u(),g("svg",zt,d[5]||(d[5]=[a("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),a("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)]))):I("",!0),a("span",null,L(T(c).processing?"Mengirim...":"Final Kirim Inspeksi"),1)],8,Dt)])])):I("",!0)]),_:1})])]))}},Kt=K(Ht,[["__scopeId","data-v-22fd310e"]]);export{Kt as default};
