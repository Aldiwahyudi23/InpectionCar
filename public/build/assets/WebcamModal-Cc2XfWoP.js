import{r as n,q as j,G as K,E as J,c as v,b as w,o as m,d as a,t as O,N as D,z as Q,A as ee,n as te}from"./vendor-g77w9U1W.js";import{_ as ae}from"./app-C1qdqtvq.js";const oe={key:0,class:"fixed inset-0 z-40 p-0 webcam-modal-container"},se={class:"webcam-content-box"},ne={class:"webcam-header"},ie={class:"rounded-full text-white hover:bg-gray-700 transition-colors"},le={class:"inspection-point-name"},ce={key:0,class:"screen-flash-overlay"},re={key:2,class:"zoom-controls"},ue=["max"],de={class:"webcam-footer"},ve={class:"camera-controls"},me=["disabled"],pe={class:"camera-icon-container"},he={key:0,class:"camera-spinner"},fe={key:1,class:"camera-body"},ge={__name:"WebcamModal",props:{show:Boolean,aspectRatio:Number,settings:Object,point:Object},emits:["close","photoCaptured"],setup(f,{emit:P}){const u=f,F=P,p=n(null),B=n(null);let r=null,i=null;const C=n("environment"),T=n(!1),M=n(!1),h=n(!1),_=n(!1),E=n(!1),V=n({}),y=n(!1),I=n(1),z=n(1),R=n(!1),W=j(()=>{var e;return((e=u.settings)==null?void 0:e.max_size)||2048}),H=j(()=>u.aspectRatio?{aspectRatio:`${u.aspectRatio} / 1`,maxWidth:"100%",maxHeight:"70vh",margin:"0 auto"}:{}),N=j(()=>{if(!u.aspectRatio)return{};const e=u.aspectRatio,t=e>1?80:60,o=e>1?80/e:60*e;return{width:`${t}%`,height:`${o}%`}}),Z=async()=>{r&&r.getTracks().forEach(e=>e.stop());try{const e={facingMode:C.value,width:{ideal:4096},height:{ideal:2160},aspectRatio:{ideal:u.aspectRatio||1.3333333333333333},frameRate:{ideal:30},advanced:[{focusMode:"continuous"},{exposureMode:"continuous"},{whiteBalanceMode:"continuous"}]};r=await navigator.mediaDevices.getUserMedia({video:e,audio:!1}),i=r.getVideoTracks()[0],p.value.srcObject=r,p.value.onloadedmetadata=async()=>{await U(),await p.value.play()}}catch(e){console.error("Error accessing camera: ",e),alert("Failed to access camera. Please allow camera permission."),F("close")}},$=()=>{r&&r.getTracks().forEach(e=>e.stop()),F("close")},U=async()=>{if(i)try{const e=await navigator.mediaDevices.enumerateDevices();T.value=e.filter(o=>o.kind==="videoinput").length>1;const t=i.getCapabilities();t.zoom?(R.value=!0,z.value=t.zoom.max,console.log(`Zoom supported. Max zoom: ${z.value}`)):(R.value=!1,console.warn("Zoom is not supported by this camera.")),M.value=t.torch||t.fillLightMode&&t.fillLightMode.includes("torch")}catch(e){console.error("Error checking camera capabilities:",e)}},L=async e=>{if(!i)return;const t=p.value.getBoundingClientRect(),o=e.clientX-t.left,s=e.clientY-t.top;E.value=!0,V.value={left:`${o}px`,top:`${s}px`,transform:"translate(-50%, -50%)"};try{if(i.getCapabilities().pointsOfInterest){const d=o/t.width,c=s/t.height;await i.applyConstraints({advanced:[{focusMode:"manual",pointsOfInterest:[{x:d,y:c}]}]})}else console.warn("Manual focus with point of interest is not supported.")}catch(l){console.warn("Manual focus failed:",l)}setTimeout(()=>{E.value=!1,i.getCapabilities().focusMode.includes("continuous")&&i.applyConstraints({advanced:[{focusMode:"continuous"}]})},1e3)},q=async e=>{if(!i||!R.value)return;const t=Math.min(Math.max(e,1),z.value);I.value=t;try{await i.applyConstraints({advanced:[{zoom:t}]})}catch(o){console.error("Failed to set zoom:",o)}},A=async()=>{if(!(!i||!M.value))try{C.value==="user"?(h.value=!h.value,_.value=h.value):(await i.applyConstraints({advanced:[{torch:!h.value}]}),h.value=!h.value)}catch(e){console.error("Flash toggle failed:",e)}},X=async()=>{T.value&&(C.value=C.value==="environment"?"user":"environment",r&&r.getTracks().forEach(e=>e.stop()),await Z())},G=async e=>new Promise(t=>{const o=W.value*1024;if(e.size<=o){t(e);return}const s=new Image,l=new FileReader;l.onload=d=>{s.onload=()=>{const c=document.createElement("canvas"),b=c.getContext("2d"),S=Math.sqrt(o/e.size);c.width=s.width*S,c.height=s.height*S,b.drawImage(s,0,0,c.width,c.height);let k=.9;const x=()=>{c.toBlob(g=>{g.size>o&&k>.1?(k-=.1,x()):t(g)},"image/jpeg",k)};x()},s.src=d.target.result},l.readAsDataURL(e)}),Y=async()=>{if(!(y.value||!p.value||!B.value)){y.value=!0;try{const e=p.value,t=B.value,o=e.videoWidth,s=e.videoHeight;let l,d,c,b;o/s>u.aspectRatio?(d=s,l=s*u.aspectRatio,c=(o-l)/2,b=0):(l=o,d=o/u.aspectRatio,c=0,b=(s-d)/2),t.width=l,t.height=d,t.getContext("2d").drawImage(e,c,b,l,d,0,0,l,d);const k=await new Promise(g=>{t.toBlob(g,"image/jpeg",1)}),x=await G(k);if(x){const g=new File([x],`capture_${Date.now()}.jpeg`,{type:"image/jpeg",lastModified:Date.now()});F("photoCaptured",g),_.value=!0,setTimeout(()=>{_.value=!1},100)}}catch(e){console.error("Error capturing photo:",e),alert("Failed to capture photo. Please try again.")}finally{y.value=!1}}};return K(()=>u.show,e=>{e?Z():$()}),J(()=>{r&&r.getTracks().forEach(e=>e.stop())}),(e,t)=>{var o;return f.show?(m(),v("div",oe,[a("div",se,[a("div",ne,[a("p",ie,O(f.settings.camera_aspect_ratio),1),a("div",le,O(((o=f.point)==null?void 0:o.name)||"Camera"),1),a("button",{onClick:$,class:"p-2 rounded-full text-white hover:bg-gray-700 transition-colors"},t[2]||(t[2]=[a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))]),a("div",{class:"webcam-video-container",style:D(H.value),onClick:L,onTouchstart:L},[a("video",{ref_key:"webcamVideo",ref:p,autoplay:"",playsinline:"",class:"webcam-video"},null,512),a("canvas",{ref_key:"webcamCanvas",ref:B,class:"hidden"},null,512),_.value?(m(),v("div",ce)):w("",!0),a("div",{class:"aspect-ratio-guide",style:D(N.value)},null,4),E.value?(m(),v("div",{key:1,class:"focus-indicator",style:D(V.value)},t[3]||(t[3]=[a("div",{class:"focus-ring"},null,-1)]),4)):w("",!0),t[4]||(t[4]=a("div",{class:"hd-badge"},[a("span",{class:"hd-text"},"HD")],-1)),R.value?(m(),v("div",re,[Q(a("input",{type:"range",min:"1",max:z.value,step:"0.1","onUpdate:modelValue":t[0]||(t[0]=s=>I.value=s),onInput:t[1]||(t[1]=s=>q(parseFloat(s.target.value))),class:"zoom-slider"},null,40,ue),[[ee,I.value]])])):w("",!0)],36),a("div",de,[a("div",ve,[f.settings.enable_flash&&M.value?(m(),v("button",{key:0,onClick:A,class:te(["control-button",{active:h.value,disabled:!M.value}])},t[5]||(t[5]=[a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 10V3L4 14h7v7l9-11h-7z"})],-1)]),2)):w("",!0),a("button",{onClick:Y,class:"capture-button",disabled:y.value},[a("div",pe,[y.value?(m(),v("div",he)):(m(),v("div",fe,t[6]||(t[6]=[a("div",{class:"camera-lens"},null,-1),a("div",{class:"camera-flash"},null,-1)])))])],8,me),f.settings.enable_camera_switch&&T.value?(m(),v("button",{key:1,onClick:X,class:"control-button"},t[7]||(t[7]=[a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"})],-1)]))):w("",!0)])])])])):w("",!0)}}},be=ae(ge,[["__scopeId","data-v-ae01207b"]]);export{be as default};
